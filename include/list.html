<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<title>List Tool</title>
	<link rel="stylesheet" href="../css/list.css">
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="../lib/socket.io.js"></script>	
	<script>	
		
		var tmpIndent = 0;	//현재 들여쓰기 상태 
		var lastId = 100;		//현재 ID 상태
		var preWindowWidth = 0;	//이전 창 사이즈
		var socket = io.connect('http://61.43.139.159:8000');	//socket.io 서버에 접속
		var tmpParentInfo = 0;		//현재 Parent 정보

		//처음 창 로딩시 호출
		$(document).ready(function() {

			//Bullet 클릭 이벤트 등록
			$('.list_space').delegate('.bullet', 'click', function() {
				var tmpSelectEdit = $(this).parent().parent();
				if ( tmpSelectEdit.attr('class') == "edit_open")
				{
					var tmpChildren = tmpSelectEdit.children('.children');
					tmpChildren.toggle(100);
				}
				
				var tmpSelectId = $(this).parent().attr('taskid');
				socket.emit('click_child',  { selectId: tmpSelectId }); 
			});

			//Checkbox 클릭 이벤트 등록
			$('.list_space').delegate('.check_box', 'click', function() {
				var tmpCheckBox = $(this);
				var tmpSelectInput = $(this).parent();

				if ( tmpCheckBox.is(':checked') )
				{
					tmpSelectInput.children('.tmp_editing').css({ "ime-mode": "readonly" });
					tmpSelectInput.children('.tmp_editing').css({ "text-decoration": "line-through" });
				}
				else
				{
					tmpSelectInput.children('.tmp_editing').css({ "ime-mode": "auto" });
					tmpSelectInput.children('.tmp_editing').css({ "text-decoration": "" });	
				}
			});

			//창 크기 조절 이벤트 발생 시
			$(window).resize(function() {
				resizeWindow();
			});
		}); 

		//창 크기에 맞춰 입력 영역 조절하는 함수
		function resizeWindow() {
			var tmpWindowWidth = $(window).width();
				
			if ( parseInt(tmpWindowWidth) <= 960)	 //960보다 작을 때 (20+880+20+margin 40)
			{
				var inputBox = $('.tmp_editing');
				var numBox = inputBox.length;
				var i=0;
				
				if ( parseInt(tmpWindowWidth) <= parseInt(preWindowWidth) )	//창 크기 이전 크기보다 작아질 때
				{			
					for ( i=0; i<numBox; i++ )
					{
						var tmpBox = $('.tmp_editing:nth('+i+')');
		
						var tmpBoxParent = tmpBox.parent();
						var tmpBoxWidth = tmpBox.width();
						var tmpWidth = parseInt(tmpWindowWidth) -  80;
						var decreaseNum = parseInt( tmpBoxWidth - parseInt(tmpWidth) );

						if ( tmpBoxParent.attr('indent') == 0 )
						{
							tmpBox.css({ "width": parseInt(tmpBoxWidth) - parseInt(decreaseNum) });
						}
						else
						{
							var tmpBoxIndent = tmpBoxParent.attr('indent');											
							tmpBox.css({ "width": parseInt(tmpBoxWidth) - (20*parseInt(tmpBoxIndent)) - parseInt(decreaseNum) });
						}
					}
				}		
				else	//창 크기 이전 크기보다 커질 때
				{	
					for ( i=0; i<numBox; i++ )
					{
						var tmpBox = $('.tmp_editing:nth('+i+')');
		
						var tmpBoxParent = tmpBox.parent();
						var tmpBoxWidth = tmpBox.width();
						var tmpWidth = parseInt(tmpWindowWidth) -  80;
						var increaseNum = parseInt( parseInt(tmpWidth) - tmpBoxWidth );

						if ( tmpBoxParent.attr('indent') == 0 )
						{
							tmpBox.css({ "width": parseInt(tmpBoxWidth) + parseInt(increaseNum) });
						}
						else
						{						
							var tmpBoxIndent = tmpBoxParent.attr('indent');																		
							tmpBox.css({ "width": parseInt(tmpBoxWidth) + parseInt(increaseNum) });
						}
					}
				}					
				preWindowWidth = tmpWindowWidth;	//창 이전 크기 저장
			}
		}
	
		//socket 오픈. 초기 리스트 데이터 가져옴
		socket.on('open', function (data) {
			if ( data.parent )	//부모 정보일 경우
			{
				console.log("Parent: "+data.parent);
				tmpParentInfo = data.parent;
			}
			else	//자식 정보일 경우
			{
				if ( tmpParentInfo == "root" )
				{
					//var childArray = new Array();
					for(var i in data) {
						var rootTag = "<div class='edit_task'><div class='input_task' indent='0' taskId="+i+"><a class='bullet'>•</a><input type='text' class='tmp_editing' onClick='mouseFocus()' onKeyDown='keyInput()' tabindex='0' value="+data[i]+"><input type='checkbox' class='check_box'></div></div>";
						$('.list_space > .children').append(rootTag);
						lastId = parseInt(lastId) + 1;
					}
			
				}
				else
				{
					var checkFirst = 1;		//첫번째 자식인지 확인하기 위한 변수
					for(var i in data) {
						var childParentInput = $('[taskid='+tmpParentInfo+']');
						var childParent = childParentInput.parent();
						var parentIndent = childParentInput.attr('indent');
						var childIndent = parseInt(parentIndent) +1;
						var childTag = "<div class='edit_task'><div class='input_add' indent="+childIndent+" taskId="+i+"><a class='bullet'>•</a><input type='text' class='tmp_editing' onClick='mouseFocus()' onKeyDown='keyInput()' tabindex='0' value="+data[i]+"><input type='checkbox' class='check_box'></div></div>";
						if ( checkFirst == 1 )
						{
							childParent.attr('class', 'edit_open');
							childTag = "<div class='children'>"+childTag+"</div>";
							childParent.append(childTag);	
							checkFirst = 0;
						}
						else
						{
							childParent.children('.children').append(childTag);
						}
						setIndent(childIndent);	 //들여쓰기 설정
						lastId = parseInt(lastId) + 1;
					}				
					//$('.input_open').attr('taskId', lastId);	//현재 입력중인 창 ID 갱신
				}
				var lastInput = $('.input_task:last');
				lastInput.attr('class', 'input_open');
				$('.input_open > .tmp_editing').trigger('focus'); 
				//	console.log($('.input_open > .tmp_editing').attr('class'));
				resizeWindow();
			}
		});

		//get_data 함수 - data 서버에서 가져옴
		socket.on('get_data', function (data) {
			console.log(data);

			var addId = data.id;
			var addParent = data.parent;
			var addIndex = data.index;
			var addVal = data.val;
			
			//해당 인덱스에 존재하는 Edit 태그 찾기
			var preInput = $('.bullet:eq('+addIndex+')');
			var preInputParent = preInput.parent();
			var preEdit = preInputParent.parent();

			lastId = parseInt(lastId) + 1;
		//	$('.input_open').attr('taskId', lastId);	//현재 입력중인 곳 ID 업데이트

			var tmpTask = $('[taskid='+addId+']');
			if ( tmpTask.length > 0 )	//자신의 id 가진 객체 존재시
			{	
				console.log("1111111");
				var changeInput = $('[taskid='+addId+']');
				changeInput.children('.tmp_editing').val(addVal);	//값 업데이트
			}
			else
			{
				var addTag = "";
				if ( addParent == 0 )	//현재 추가하려는 데이터의 부모가 Root일 때
				{
					addTag = "<div class='edit_task'><div class='input_task' indent='0' taskid="+addId+"><a class='bullet'>•</a><input type='text' class='tmp_editing' onClick='mouseFocus()' onKeyDown='keyInput()' tabindex='0' value="+addVal+"><input type='checkbox' class='check_box'></div></div>";
					if ( preEdit.length == 0 )	//정의 안 된경우
					{
						console.log("3333333333");
						preEdit = $('.list_space > .children');
						preEdit.append(addTag);
					}
					else
					{
						console.log("44444444");
						preEdit.before(addTag);
					}	
				}
				else	//부모가 Root가 아닐 때
				{
					addIndex = parseInt(addIndex) -1;
					preInput = $('.bullet:eq('+addIndex+')');
					preInputParent = preInput.parent();
					preEdit = preInputParent.parent();

					var addInputParent = $('[taskid='+addParent+']');
					var addParentIndent = parseInt(addInputParent.attr('indent'));
					var preInputIndent = parseInt(preInputParent.attr('indent'));

					var tmpIndentStatus = parseInt(addInputParent.attr('indent')) + 1;	//부모보다 한칸 들여쓰기

					console.log( "Index: "+addIndex+" // add: "+addParentIndent+" // pre: "+preInputIndent);

					addTag = "<div class='edit_task'><div class='input_add' indent="+tmpIndentStatus+" taskid="+addId+"><a class='bullet'>•</a><input type='text' class='tmp_editing' onClick='mouseFocus()' onKeyDown='keyInput()' tabindex='0' value="+addVal+"><input type='checkbox' class='check_box'></div></div>";
								
					if (addParentIndent == preInputIndent)	//첫번째 자식일 경우	
					{
						//console.log("첫번째 자식//"+preEdit.attr('class'));
						if ( preEdit.attr('class') == "edit_open")
						{
							preEdit.children('.children').prepend(addTag);
						}
						else
						{
							addTag = "<div class='children'>" + addTag + "</div>";
							preEdit.attr('class', 'edit_open');
							preEdit.append(addTag);
						}
					}
					else if ( addParentIndent < preInputIndent-1 )	//앞으로 내어쓰기 한 경우
					{
						//console.log("내어쓰기//"+preEdit.attr('class'));
						preEdit.parent().parent().after(addTag);				
					} 
					else	//같은 레벨로 계속 추가
					{		
						//console.log("같은레벨//"+preEdit.attr('class'));
						preEdit.after(addTag);
					}
				}
				$('.input_open > .tmp_editing').trigger('focus'); 
				setIndent(tmpIndentStatus);	//들여쓰기 설정		
			}

		});
		
		//데이터 DB에 데이터 요청 (Home 클릭시)
		function requireData(idNum) {
			var tmpSelectId = 0;
			if(parseInt(idNum) == 0){
				tmpSelectId = "root";
			}
			socket.emit('require_data',  { selectId: tmpSelectId }); 
		} 
	
		//input 마우스로 클릭시 호출되는 함수
		function mouseFocus(){
			//alert("Mouse focus");

			var focusClass = $('input:focus').parent();
	
			if( focusClass.attr('class') != "input_open" )
			{
				////이전에 작성 중이던 데이터 저장////		
				var preInput = $('.input_open');
				var preId = preInput.attr('taskid');		//자신의 id 가져옴	
				var parentId = 0;	 
				var preIndentStatus =  preInput.attr('indent');
				if( preIndentStatus != 0 ) {
					var parentChildrenClass = preInput.parent().parent();
					parentId = parentChildrenClass.prev('.input_task').attr('taskid');	//부모 id 가져옴
				}
				
				var preBullet = $('.input_open a');
				var preIndex = $('.bullet').index(preBullet);	 //이전 Index 구함
				var preVal = $('.input_open > .tmp_editing').val();	//이전 값 구함
				
				//서버 소켓으로 데이터 전송
				socket.emit('set_data', { id: preId, parent: parentId, index: preIndex, val: preVal } );
				
				//포커싱된 클래스 상태 open으로 변경 및 기존 open 클래스 task로 변경
				focusClass = $('input:focus');
				tmpIndent = focusClass.parent('.input_task').attr('indent');
				focusClass.parent('.input_task').attr('class', 'input_open');
				
				preInput.attr('class', 'input_task');

			}		
		}

		//들여쓰기 공백 설정해주는 함수
		function setIndent(indentStatus) {
			var tmpInput = $('.input_add');	//추가된 태그인 경우
			if ( tmpInput.attr('class') )
			{
				tmpInput = $('.input_add > .tmp_editing');
				var tmpBullet = $('.input_add > .bullet');
				var tmpBulletLeft = tmpBullet.css('margin-left');
				var tmpWidth = tmpInput.width();
				tmpBullet.css({"margin-left": parseInt(5) + (20*parseInt(indentStatus)) });
				tmpInput.css({ "margin-left": 10 });
				tmpInput.css({ "width": parseInt(tmpWidth) - (20*parseInt(indentStatus)) });
				$('.input_add').attr('class', 'input_task');
			}
			else 
			{		
				tmpInput = $('.input_open > .tmp_editing');
				var tmpBullet = $('.input_open > .bullet');
				var tmpBulletLeft = tmpBullet.css('margin-left');
				var tmpWidth = tmpInput.width();
				tmpBullet.css({"margin-left": parseInt(5) + (20*parseInt(indentStatus)) });
				tmpInput.css({ "margin-left": 10 });
				tmpInput.css({ "width": parseInt(tmpWidth) - (20*parseInt(indentStatus)) });
				tmpInput.trigger('focus');
			}
		}
	
		//input 키보드 입력시 호출되는 함수
		function keyInput() {
			var inputKey = event.keyCode;
			if ( inputKey == 13 )	//Input Enter
			{
				//alert("Enter");
				
				////이전에 작성 중이던 데이터 저장////		
				var preInput = $('.input_open');
				
				var preId = preInput.attr('taskid');	//자신의 id 가져옴		
				var parentId = 0;	 	
				var preIndentStatus =  preInput.attr('indent');
				if( preIndentStatus != 0 ) {
					var parentChildrenClass = preInput.parent().parent();
					parentId = parentChildrenClass.prev('.input_task').attr('taskid');	//부모 id 가져옴
					//alert(parentId);
				}
				
				var preBullet = $('.input_open a');
				var preIndex = $('.bullet').index(preBullet);		//이전 Index 구함			
				var preVal = $('.input_open > .tmp_editing').val();	//이전 값 구함
				
				//서버 소켓으로 데이터 전송
				socket.emit('set_data', { id: preId, parent: parentId, index: preIndex, val: preVal } );
				
				preInput.attr('class', 'input_task');		
					
				lastId = parseInt(lastId)+1;	//id 1 증가

				var addTag = "<div class='edit_task'><div class='input_open' indent="+tmpIndent+" taskid="+lastId+"><a class='bullet'>•</a><input type='text' class='tmp_editing' onClick='mouseFocus()' onKeyDown='keyInput()' tabindex='0'><input type='checkbox' class='check_box'></div></div>";

				var preInputParent = preInput.parent(); 

				//자식 노드 존재하는 경우 자식노드로 추가
				if( preInputParent.attr('class') == "edit_open" )
				{
					tmpIndent = parseInt(tmpIndent) + 1;
					preInputParent.children('.children').prepend(addTag);
					$('.input_open').attr('indent', tmpIndent);
				}
				else
				{
					preInputParent.after(addTag);
				}
				$('.input_open > .tmp_editing').trigger('focus'); 
				var tmpIndentStatus = $('.input_open').attr('indent'); 
				setIndent(tmpIndentStatus);	//들여쓰기 설정
				resizeWindow();
			}
			else if ( inputKey == 9 && event.shiftKey ) //Input Shift + Tab
			{
				//alert("Shift+Tab");
				event.returnValue = false;
				
				if(tmpIndent > 0) {	
					tmpIndent = parseInt(tmpIndent)-1;
					var tmpInput = $('.input_open');
					var tmpId = tmpInput.attr('taskid');
					var tmpVal = $('.input_open > .tmp_editing').val();
					
					var tmpInputParent = $('.input_open').parent();
					
					var addTag = "<div class=edit_task><div class='input_open' indent="+tmpIndent+" taskid="+tmpId+"><a class='bullet'>•</a><input type='text' class='tmp_editing' onClick='mouseFocus()' onKeyDown='keyInput()' tabindex='0' value="+tmpVal+"><input type='checkbox' class='check_box'></div></div>";		

					if( tmpInputParent.parent().attr('class') == "children" )
					{
						tmpInputParent.parent().parent().after(addTag);
						tmpInputParent.remove();
					}
					var tmpIndentStatus = $('.input_open').attr('indent');
					setIndent(tmpIndentStatus);	//들여쓰기 설정 함수 호출
				}			
				
			}
			else if ( inputKey == 9 )	//Input Tab		
			{
				//alert("Tab");
				event.returnValue = false;
					
				var tmpInput = $('.input_open');
				var tmpId = tmpInput.attr('taskid');
				var tmpVal = $('.input_open > .tmp_editing').val();
								
				var tmpInputParent = $('.input_open').parent();

				var preClass = tmpInputParent.prev();
				//alert(preEditTask.attr('class'));
				//직전 클래스가 edit_task인 경우 추가하려는 children 태그 추가
				if ( preClass.attr('class') == "edit_task" )
				{
					tmpIndent = parseInt(tmpIndent)+1;
					tmpInput.parent().remove();
				
					preClass.attr('class', "edit_open");
					
					var addTag = "<div class='children'><div class=edit_task><div class='input_open' indent="+tmpIndent+" taskid="+tmpId+"><a class='bullet'>•</a><input type='text' class='tmp_editing' onClick='mouseFocus()' onKeyDown='keyInput()' tabindex='0' value="+tmpVal+"><input type='checkbox' class='check_box'></div></div></div>";
					preClass.append(addTag);


					var tmpIndentStatus = $('.input_open').attr('indent');
					setIndent(tmpIndentStatus);
				}
				//직전 클래스가 edit_open인 경우 태그만 추가
				else if ( preClass.attr('class') == "edit_open" )	
				{
					tmpIndent = parseInt(tmpIndent)+1;
					tmpInput.parent().remove();
					var addTag = "<div class=edit_task><div class='input_open' indent="+tmpIndent+" taskid="+tmpId+"><a class='bullet'>•</a><input type='text' class='tmp_editing' onClick='mouseFocus()' onKeyDown='keyInput()' tabindex='0' value="+tmpVal+"><input type='checkbox' class='check_box'></div></div>";
					preClass.children('.children').append(addTag);

					var tmpIndentStatus = $('.input_open').attr('indent');
					setIndent(tmpIndentStatus);

				}
			//	var tmpIndentStatus = $('.input_open').attr('indent');
			//	setIndent(tmpIndentStatus);
			}	
			else if ( inputKey == 8 )	//Input BackSpaceKey
			{
				
				//alert("BackSpace");
				
				var tmpInput = $('.input_open');
				var tmpId = tmpInput.attr('taskid');
				var tmpVal = $('.input_open > .tmp_editing').val();
								
				var tmpInputParent = $('.input_open').parent();
								
				if( tmpVal == "" )
				{
					event.returnValue = false;
					
					if ( tmpInputParent.attr('class') != "edit_open" )
					{
						var preClass = tmpInputParent.prev();
						if ( preClass.attr('class') == "edit_task" )
						{
							preClass.children('.input_task').attr('class', 'input_open');
							preClass.children('.input_open').children('.tmp_editing').trigger('focus');
							
							tmpIndent = preClass.children('.input_open').attr('indent');
							
							tmpInputParent.remove();
						}
						else if ( preClass.attr('class') == "edit_open" )
						{
							var preEditClass = preClass.children('.children').children('.edit_task:last');
							preEditClass.children('.input_task').attr('class', 'input_open');
							preEditClass.children('.input_open').children('.tmp_editing').trigger('focus');
							
							tmpIndent = preEditClass.children('.input_open').attr('indent');
						
							tmpInputParent.remove();
						}
						else 
						{
							preClass = tmpInputParent.parent().parent();
							var otherEditClass = tmpInputParent.next();
							
							var preInputClass = preClass.children('.input_task:last');
							preInputClass.attr('class', 'input_open');
							
							tmpIndent = preInputClass.attr('indent');

							preInputClass.children('.tmp_editing').trigger('focus');
						
							if ( otherEditClass.attr('class') == "edit_task" || otherEditClass.attr('class') == "edit_open"  )
							{
								tmpInputParent.remove();
							}
							else
							{
								tmpInputParent.parent().parent().attr('class', 'edit_task');
								tmpInputParent.parent().remove();
							}
							
						}
						
					}
				
				}
				
			}
		}

	</script>
</head>
<body>
<div id="wrapper">
	<header id="main_header">
		<h1>List Tool</h1>
	</header>
	<div id="container">
    <section id="main_section">
		<article>
			<header>
				<div class="home_line">
					<div id="homeButton" onClick="requireData(0)"><h2>Home</h2></div>
				</div>
			</header>
			<div class="list_space">
				<div class="children">
				
				</div>
			

			</div>
		</article>
    </section>
	</div>
</div>
</body>
</html>
